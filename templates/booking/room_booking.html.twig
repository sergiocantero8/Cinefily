{% extends 'base.html.twig' %}

{% block title %}Asientos | Cinefily{% endblock %}


{% block main %}

    <!--suppress HtmlFormInputWithoutLabel, EqualityComparisonWithCoercionJS -->
    <div class="booking-page">

        <div class="row">
            {# Detalles de la sesión: nombre del evento, portada, horario... #}
            <div class="col-12 col-md-2">
                {% include 'booking/includes/session_details.html.twig' %}
            </div>
            <div class="col-12 col-md-10">
                {# Formulario para introducir email y número de asientos #}
                <div class="inputForm d-flex justify-content-center m-4">
                    <div class="row">
                        <div class="col-12 col-md-4">
                            <label for="userEmail">Email:</label>
                            <input type="email" class="form-control" id="userEmail" required>
                            <small id="emailHelp" class="form-text text-muted">Email que recibirá las entradas</small>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="numSeats">Número de asientos: </label>
                            <input type="number" class="form-control" id="numSeats" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <button onclick="takeData()" class=" btn btn-dark btn-sm">Empezar seleccion</button>
                        </div>
                        <div class="col-12 col-md-6" id="notification"></div>
                    </div>
                </div>
                {# Termina formulario #}


                <div class="d-flex justify-content-center m-4">

                    <div class="seatStructure">

                        <table id="seatsBlock">

                            <tr>
                                <td colspan="14">
                                    <div class="screen ml-5">PANTALLA</div>
                                </td>
                                <td rowspan="20">
                                    <div class="smallBox greenBox text-white ml-2">Seleccionado</div>
                                    <br/>
                                    <div class="smallBox redBox text-white ml-2">Reservado</div>
                                    <br/>
                                    <div class="smallBox emptyBox text-white ml-2">Vacío</div>
                                    <br/>
                                </td>

                                <br/>
                            </tr>

                            {# Este bucle es sólo para mostrar el número de asiento #}
                            <tr>
                                <td class="text-white font-weight-bold"> Nº asiento</td>
                                {% set space= 0 %}
                                {% for i in 1..room.getNColumns() %}
                                    {% if space==0 and i>= (room.getNColumns()/2) %}
                                        {% set space= 1 %}
                                        <td class="space">space</td>
                                    {% endif %}
                                    <td class="text-white">{{ i }}</td>
                                {% endfor %}
                            </tr>

                            {#
                            Este bucle crea los asientos poniendole el valor de la fila y columna. Hay dos espacios
                                en la sala a tener en cuenta: un sólo espacio que hay entre la mitad de las filas y un
                                espacio por cada mitad de las columnas.
                                Por eso creamos una variable fuera del bucle para indicar que aún no se ha creado el
                                espacio entre las filas. Cuando se cree, la ponemos a uno y no volverá a crear ningún
                                espacio. Sin embargo en el espacio entre columnas, se creo uno por cada fila por lo que
                                al empezar el bucle de creación de la fila se resetea el valor de espacio entre columnas
                            #}
                            {% set spaceRow= 0 %}
                            {% for i in 1..room.getNRows() %}
                                {% set spaceColumns= 0 %}
                                {% if spaceRow==0 and i>= (room.getNRows()/2) %}
                                    {% set spaceRow= 1 %}
                                    <tr class="seatVGap"></tr>
                                {% endif %}
                                <tr>
                                    <td class="text-white">{{ i }}</td>
                                    {% for j in 1..room.getNColumns() %}
                                        {% if spaceColumns == 0 and j>= (room.getNColumns()/2) %}
                                            <td></td>
                                            {% set spaceColumns= 1 %}
                                        {% endif %}
                                        <td>
                                            <input type="checkbox" class="seats"
                                                   value="Fila {{ i }} Asiento {{ j }},">
                                        </td>
                                    {% endfor %}
                                </tr>


                            {% endfor %}

                        </table>

                        <br/>

                    </div>

                </div>

                <div class="d-flex justify-content-center mb-4">
                    <button onclick="updateTextArea()" class="btn btn-dark btn-sm">Confirmar selección</button>
                </div>

                {#
                <div class="displayerBoxes">
                    <table class="table-responsive d-flex justify-content-center">
                        <tr>
                            <th>Email</th>
                            <th>Número de asientos</th>
                            <th>Asientos</th>
                        </tr>
                        <tr>
                            <td><textarea id="nameDisplay"></textarea></td>
                            <td><textarea id="NumberDisplay"></textarea></td>
                            <td><textarea id="seatsDisplay"></textarea></td>
                        </tr>

                    </table>
                </div>
                #}
            </div>
        </div>
    </div>

{% endblock %}

{% block custom_body_javascript %}

    <script>

        // Desactivamos la zona interactiva de reservar y el resultado
        $('.booking-page').ready(function () {
            $(".seatStructure *").prop('disabled', true);
            $(".displayerBoxes *").prop('disabled', true);
        });

        // Función que toma los datos del usuario (email y numero de asientos)
        function takeData() {
            // Si no se ha introducido ningún dato
            if (($("#userEmail").val().length == 0) || ($("#numSeats").val().length == 0)) {
                alert("Introduce tu email y el número de asientos");
            } else {
                $(".inputForm *").prop("disabled", true);
                $(".seatStructure *").prop("disabled", false);
                document.getElementById("notification").innerHTML = "<b style='margin-bottom:0px;background:yellow;'>Selecciona tus asientos</b>";
            }
        }


        // Función para actualizar los texts Areas con los datos de la selección
        function updateTextArea() {

            if ($("input:checked").length == ($("#numSeats").val())) {
                $(".seatStructure *").prop("disabled", true);

                var allEmailVals = [];
                var allNumberVals = [];
                var allSeatsVals = [];

                // Guardando los valores en sus arrays respectivamente
                allEmailVals.push($("#userEmail").val());
                allNumberVals.push($("#numSeats").val());
                $('#seatsBlock :checked').each(function () {
                    allSeatsVals.push($(this).val());
                });


                window.location = window.location.origin + "/booking/processBooking?seats=" + allSeatsVals.toString() +
                "&id_session=" + {{ session.getId() }};
            } else {
                alert("Tienes que seleccionar " + ($("#numSeats").val()) + " asientos")
            }
        }


        function myFunction() {
            alert($("input:checked").length);
        }


        $(":checkbox").click(function () {
            if ($("input:checked").length == ($("#numSeats").val())) {
                $(":checkbox").prop('disabled', true);
                $(':checked').prop('disabled', false);
            } else {
                $(":checkbox").prop('disabled', false);
            }
        });


        function sendData() {
            console.log("Holaaa");
            var formData = new FormData();
            formData.append("userEmail", $("#nameDisplay").val());
            formData.append("nSeats", $("#NumberDisplay").val());
            formData.append("seats", $("#seatsDisplay").val());
            $.ajax({
                url: "/booking/processBooking",
                type: 'POST',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                success: function (response) {
                    alert(response);
                }
            });
        }

    </script>
{% endblock %}